<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/canvas.css">
    <script type="text/javascript" src="js/Displayer.js"></script>
    <script type="text/javascript" src="js/Animation.js"></script>
</head>
<body>
<div id="display"></div>
<input type="button" id="start_stop_btn" value="Arrêter/démarrer l'animation">
<input type="button" id="rewind_btn" value="Rembobiner l'animation">
<script type="text/javascript">
    window.onload = function () {
        let d = new Displayer(document.getElementById("display"));
        let x_pos = 0;
        let y_pos = 0;
        let rayonX = 40;
        let rayonY = 40; 
        let e = new Ellipse(x_pos, y_pos, rayonX, rayonY);
        let speedX = 5;
        let speedY = 0;
        let gravity = 0.98;
        let amortissementY = -0.9;
        let amortissementX = -1;
        let width_canvas = d.getCanvas().width, height_canvas = d.getCanvas().height;
        d.drawLine(0, height_canvas, width_canvas, height_canvas);
        let animation = new Animation(500,10);
        let StartStopBtn = document.getElementById("start_stop_btn");
        let isRunning = true;
        StartStopBtn.addEventListener("click", function() {
            if(isRunning) {
                animation.stop();
                isRunning = false;
            }
            else {
                animation.run();
                isRunning = true;
            }
        });
        let RewindBtn = document.getElementById("rewind_btn");
        let isRewinding = false;
        let states = [];
        RewindBtn.addEventListener("click", function() {
            if(isRunning) {
                animation.stop();
                isRunning = false;
            }
            if(isRewinding) {
                isRewinding = false;
                animation.run();
            }
            else {
                isRewinding = true;
            }
        });
        animation.nextStep = function(t) {
            if (isRewinding) {
                if (states.length > 0) {
                    let prevState = states.pop();
                    e.x = prevState.x;
                    e.y = prevState.y;
                    e.wx = prevState.wx;
                    e.wy = prevState.wy;
                    speedX = prevState.speedX;
                    speedY = prevState.speedY;
                } else {
                    isRewinding = false;
                }
            }
            else {
                speedY += gravity;
                let stretchFactor = 1 + Math.abs(speedY) / 100; // Facteur d'étirement de la balle, à ajuster si on veut
                e.x += speedX;
                e.y += speedY;
            
                if(e.y < height_canvas - e.wy) {
                    e.wx = rayonX / stretchFactor;
                    e.wy = rayonY * stretchFactor;
                    squashSteps = 0;
                }
                else {
                    e.y = height_canvas - e.wy;
                    speedY *= amortissementY; // Rebond
                    e.wx = rayonX * 1.1;
                    e.wy = rayonY * 0.9;
                }
                if(e.x > width_canvas - e.wx) {
                    speedX *= amortissementX; // Retour en arrière si on dépasse les x ou l'origine
                    amortissementX = -1 * amortissementX;
                }
                if(e.x < 0) {
                    amortissementX = -1 * amortissementX;
                    speedX *= amortissementX
                }
                states.push({x: e.x, y: e.y, wx: e.wx, wy: e.wy, speedX: speedX, speedY: speedY});
                d.init();
                d.drawLine(0, height_canvas, width_canvas, height_canvas);
                d.drawEllipse(e);
                let framerate = animation.getFramerate();
                d.drawFramerate(framerate);
            }
        }
        animation.run();
    }

    // Version avec rebonds
    // window.onload = function () {
    //     let d = new Displayer(document.getElementById("display"));
    //     let x_pos = 10;
    //     let y_pos = 10;
    //     let rayonX = 40;
    //     let rayonY = 40; 
    //     let e = new Ellipse(x_pos, y_pos, rayonX, rayonY);
    //     let speedX = 5;
    //     let speedY = 0;
    //     let gravity = 0.98;
    //     let amortissementY = -1;
    //     let amortissementX = -1;
    //     let width_canvas = d.getCanvas().width, height_canvas = d.getCanvas().height;
    //     d.drawLine(0, height_canvas, width_canvas, height_canvas);
    //     let animation = new Animation(500,4);
    //     animation.nextStep = function(t) {
    //         speedY += gravity;
    //         e.x += speedX;
    //         e.y += speedY;
    //         if(e.x > width_canvas - e.wx) speedX *= amortissementX; // Retour en arrière si on dépasse les x
           
    //         if(e.y < height_canvas - e.wy) {
    //             e.wy = rayonY * 1.5; e.wx = rayonX * 0.5;
    //         }
    //         else {
    //             speedY *= amortissementY; // Rebond
    //             e.wx = rayonX * 1.05; e.wy = rayonY * 0.95;
    //         }
    //         d.init();
    //         d.drawLine(0, height_canvas, width_canvas, height_canvas);
    //         d.drawEllipse(e);
    //     }
    //     animation.run();
    //     }
    </script>
</body>
</html>